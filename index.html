<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pocket Tycoon – Idle Decisions (Lifestyle+)</title>
  <style>
    :root{
      --bg:#070a10; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --text:#eaf2ff; --muted:rgba(234,242,255,.75);
      --accent:#2f7cff; --accent2:#6a5cff; --danger:#ff3b3b; --good:#33d17a;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
    canvas{position:fixed;inset:0;width:100vw;height:100vh;z-index:0}
    .app{position:fixed;inset:0;z-index:1;display:flex;flex-direction:column}
    .topbar{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:12px 12px 10px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(8px);
    }
    .pill{display:flex;gap:10px;align-items:center;padding:8px 10px;border:1px solid var(--line);
      border-radius:999px;background:var(--panel)}
    .kpi{display:flex;flex-direction:column;line-height:1.1}
    .kpi b{font-size:14px}
    .kpi span{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px; padding:10px 12px; flex-wrap:wrap}
    .tab{border:1px solid var(--line); background:var(--panel); color:var(--text);
      padding:8px 10px; border-radius:12px; font-weight:800; font-size:13px}
    .tab.active{background:linear-gradient(135deg, rgba(47,124,255,.25), rgba(106,92,255,.18));
      border-color:rgba(47,124,255,.35)}
    .content{flex:1; overflow:auto; padding:0 12px 14px}
    .card{border:1px solid var(--line); background:var(--panel); border-radius:16px; padding:12px; margin:10px 0}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:12px}
    .big{font-size:18px;font-weight:900}
    .btn{
      border:0; border-radius:12px; padding:10px 12px; font-weight:900;
      background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white;
    }
    .btn.ghost{background:transparent;border:1px solid var(--line); color:var(--text)}
    .btn.danger{background:linear-gradient(135deg,#ff3b3b,#ff7a3b)}
    .btn.good{background:linear-gradient(135deg,#33d17a,#2f7cff)}
    .btn:disabled{opacity:.45}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(0,0,0,.12)}
    .item h3{margin:0 0 6px 0;font-size:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);font-size:12px;color:var(--muted)}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bar > div{height:100%;background:linear-gradient(90deg,var(--good),var(--accent))}
    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background:rgba(9,12,18,.86); border:1px solid var(--line);
      padding:10px 12px; border-radius:14px; display:none; z-index:9;
      max-width:min(520px, 92vw); color:var(--text); font-weight:700; font-size:13px;
    }
    .sep{opacity:.5}
  </style>
</head>
<body>
  <canvas id="bg"></canvas>

  <div class="app">
    <div class="topbar">
      <div class="pill">
        <div class="kpi"><b id="money">$0</b><span>Cash</span></div>
        <div class="kpi"><b id="net">$0</b><span>Net Worth</span></div>
        <div class="kpi"><b id="rate">$0/s</b><span>Net income</span></div>
        <div class="kpi"><b id="qol">50</b><span>QoL</span></div>
      </div>
      <button class="btn ghost" id="saveBtn">Save</button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="overview">Overview</button>
      <button class="tab" data-tab="business">Businesses</button>
      <button class="tab" data-tab="lifestyle">Lifestyle</button>
      <button class="tab" data-tab="finance">Finance</button>
      <button class="tab" data-tab="reports">Reports</button>
    </div>

    <div class="content">
      <div id="tab-overview" class="tabpane"></div>
      <div id="tab-business" class="tabpane" style="display:none"></div>
      <div id="tab-lifestyle" class="tabpane" style="display:none"></div>
      <div id="tab-finance" class="tabpane" style="display:none"></div>
      <div id="tab-reports" class="tabpane" style="display:none"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ----- Background (stars) -----
  const bg = document.getElementById("bg");
  const bctx = bg.getContext("2d");
  let W=innerWidth, H=innerHeight, DPR=1, stars=[];
  function resize(){
    DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
    W=innerWidth; H=innerHeight;
    bg.width=(W*DPR)|0; bg.height=(H*DPR)|0;
    bctx.setTransform(DPR,0,0,DPR,0,0);
    stars=[];
    for(let L=0; L<3; L++){
      const count=Math.floor((W*H)/(L===0?12000:L===1?17000:26000))+50;
      for(let i=0;i<count;i++){
        stars.push({
          x:Math.random()*W,y:Math.random()*H,
          r:(L===0?1.6:L===1?1.2:0.9)*(0.6+Math.random()),
          v:(L===0?22:L===1?12:7)*(0.7+Math.random()),
          a:(L===0?0.5:L===1?0.35:0.25)*(0.6+Math.random()),
          L
        });
      }
    }
  }
  addEventListener("resize", resize, {passive:true});
  resize();

  function drawBG(dt){
    bctx.fillStyle="rgba(7,10,16,0.25)";
    bctx.fillRect(0,0,W,H);

    const g1=bctx.createRadialGradient(W*0.25,H*0.3,10,W*0.25,H*0.3,Math.max(W,H)*0.8);
    g1.addColorStop(0,"rgba(47,124,255,0.10)"); g1.addColorStop(1,"rgba(0,0,0,0)");
    bctx.fillStyle=g1; bctx.fillRect(0,0,W,H);

    const g2=bctx.createRadialGradient(W*0.8,H*0.65,10,W*0.8,H*0.65,Math.max(W,H)*0.85);
    g2.addColorStop(0,"rgba(106,92,255,0.08)"); g2.addColorStop(1,"rgba(0,0,0,0)");
    bctx.fillStyle=g2; bctx.fillRect(0,0,W,H);

    for(const s of stars){
      s.y += s.v*dt;
      if(s.y>H+10){s.y=-10; s.x=Math.random()*W;}
      bctx.globalAlpha=s.a;
      bctx.beginPath(); bctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      bctx.fillStyle="white"; bctx.fill();
    }
    bctx.globalAlpha=1;
  }

  // ----- Utils -----
  const fmt = new Intl.NumberFormat(undefined,{notation:"compact",compactDisplay:"short",maximumFractionDigits:2});
  const moneyFmt = n => "$"+fmt.format(Math.max(0, n));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const now=()=>Date.now();

  // ----- Larger Lifestyle Catalog -----
  // upkeepPerSec: ongoing bills/subscriptions/maintenance
  // value & annualRate: assets appreciate (+) or depreciate (-)
  // consumable: if true, no resale value; cancelable: if true and upkeep>0, you can cancel to stop upkeep
  const LIFESTYLE = [
    // Gadgets
    { id:"earbuds", type:"Gadget", name:"Wireless Earbuds", cost:60, upkeepPerSec:0.00, value:35, annualRate:-0.30, qol:+3, rep:+0, risk:+0 },
    { id:"phone", type:"Gadget", name:"Smartphone Upgrade", cost:180, upkeepPerSec:0.00, value:120, annualRate:-0.30, qol:+6, rep:+1, risk:+0 },
    { id:"laptop",type:"Gadget", name:"Work Laptop", cost:420, upkeepPerSec:0.00, value:300, annualRate:-0.25, qol:+8, rep:+2, risk:-1 },
    { id:"tablet",type:"Gadget", name:"Tablet", cost:320, upkeepPerSec:0.00, value:220, annualRate:-0.25, qol:+6, rep:+1, risk:+0 },

    // Transport
    { id:"bike",   type:"Transport", name:"Bicycle", cost:160, upkeepPerSec:0.005, value:110, annualRate:-0.12, qol:+6, rep:+0, risk:-1 },
    { id:"scooter",type:"Transport", name:"Scooter", cost:520, upkeepPerSec:0.015, value:420, annualRate:-0.15, qol:+8, rep:+1, risk:+0 },
    { id:"usedcar",type:"Transport", name:"Used City Car", cost:900, upkeepPerSec:0.02, value:750, annualRate:-0.18, qol:+10, rep:+2, risk:+1 },
    { id:"sedan",  type:"Transport", name:"Reliable Sedan", cost:2400, upkeepPerSec:0.05, value:2050, annualRate:-0.15, qol:+14, rep:+3, risk:+2 },
    { id:"luxcar", type:"Transport", name:"Luxury Car", cost:8500, upkeepPerSec:0.16, value:7200, annualRate:-0.20, qol:+22, rep:+6, risk:+6 },

    // Homes
    { id:"rentroom", type:"Home", name:"Rent a Room (Stability)", cost:600, upkeepPerSec:0.08, value:0, annualRate:0, qol:+10, rep:+1, risk:-2, cancelable:true },
    { id:"studio", type:"Home", name:"Studio Apartment", cost:12000, upkeepPerSec:0.20, value:12000, annualRate:+0.05, qol:+18, rep:+5, risk:-2 },
    { id:"family", type:"Home", name:"Family House", cost:35000, upkeepPerSec:0.55, value:35000, annualRate:+0.06, qol:+28, rep:+8, risk:-3 },
    { id:"villa",  type:"Home", name:"Luxury Villa", cost:120000, upkeepPerSec:1.70, value:120000, annualRate:+0.07, qol:+40, rep:+14, risk:+2 },

    // Furniture & Living
    { id:"bed",   type:"Living", name:"Quality Bed & Mattress", cost:480, upkeepPerSec:0.00, value:260, annualRate:-0.20, qol:+10, rep:+0, risk:-1 },
    { id:"desk",  type:"Living", name:"Office Desk Setup", cost:300, upkeepPerSec:0.00, value:180, annualRate:-0.20, qol:+7, rep:+1, risk:-1 },
    { id:"sofa",  type:"Living", name:"Comfort Sofa", cost:420, upkeepPerSec:0.00, value:240, annualRate:-0.20, qol:+6, rep:+0, risk:+0 },

    // Clothing & Accessories
    { id:"wardrobe", type:"Style", name:"Wardrobe Upgrade", cost:260, upkeepPerSec:0.00, value:80, annualRate:-0.60, qol:+6, rep:+2, risk:+0 },
    { id:"watch",    type:"Style", name:"Classic Watch", cost:650, upkeepPerSec:0.00, value:450, annualRate:-0.10, qol:+4, rep:+4, risk:+0 },
    { id:"luxwatch", type:"Style", name:"Luxury Watch", cost:6500, upkeepPerSec:0.00, value:6200, annualRate:-0.02, qol:+8, rep:+10, risk:+3 },

    // Subscriptions & Habits
    { id:"gym",   type:"Subscriptions", name:"Gym Membership", cost:40, upkeepPerSec:0.015, value:0, annualRate:0, qol:+10, rep:+1, risk:-3, cancelable:true },
    { id:"stream",type:"Subscriptions", name:"Streaming Subscription", cost:15, upkeepPerSec:0.006, value:0, annualRate:0, qol:+4, rep:+0, risk:+0, cancelable:true },
    { id:"coffee",type:"Subscriptions", name:"Daily Coffee Habit", cost:10, upkeepPerSec:0.008, value:0, annualRate:0, qol:+2, rep:+0, risk:+2, cancelable:true },
    { id:"therapy",type:"Subscriptions", name:"Coaching / Therapy", cost:120, upkeepPerSec:0.02, value:0, annualRate:0, qol:+12, rep:+1, risk:-4, cancelable:true },

    // Protection
    { id:"insure", type:"Protection", name:"Health & Business Insurance", cost:650, upkeepPerSec:0.06, value:0, annualRate:0, qol:+6, rep:+2, risk:-10, cancelable:true },
    { id:"homealarm", type:"Protection", name:"Home Security System", cost:380, upkeepPerSec:0.01, value:180, annualRate:-0.15, qol:+2, rep:+0, risk:-6 },

    // Pets
    { id:"cat", type:"Pets", name:"Adopt a Cat", cost:60, upkeepPerSec:0.01, value:0, annualRate:0, qol:+8, rep:+0, risk:-1 },
    { id:"dog", type:"Pets", name:"Adopt a Dog", cost:120, upkeepPerSec:0.018, value:0, annualRate:0, qol:+10, rep:+1, risk:-2 },

    // Experiences (consumables)
    { id:"holiday",type:"Experiences", name:"Holiday (Short Break)", cost:220, upkeepPerSec:0.00, value:0, annualRate:0, qol:+12, rep:+0, risk:-2, consumable:true },
    { id:"concert",type:"Experiences", name:"Concert Night", cost:80, upkeepPerSec:0.00, value:0, annualRate:0, qol:+6, rep:+0, risk:+0, consumable:true },
  ];

  // ----- Save/Load -----
  const KEY="pocket_tycoon_lifestyle_plus_v1";

  const S = {
    money: 50,
    reputation: 50,    // 0..100
    risk: 40,          // computed
    qol: 50,           // 0..100
    policy:"balanced",
    lastTick: now(),
    lastSave: now(),
    totalEarned: 0,
    totalLost: 0,
    decisionCooldown: 0,
    dayTimer: 0,
    loans: [], // {id, principal, rateAPR, paymentPerSec, remaining}
    assets: [], // {id, name, type, purchaseTime, value, upkeepPerSec, annualRate, qol, rep, risk, cancelable, consumable}
    businesses: [
      { id:"lemon", name:"Street Snacks", unlocked:true,  level:1, base:0.90, expense:0.18, unlockCost:0,    risk:10, rep:2 },
      { id:"shop",  name:"Online Store",  unlocked:false, level:0, base:3.20, expense:0.85, unlockCost:250,  risk:18, rep:4 },
      { id:"fleet", name:"Delivery Fleet",unlocked:false, level:0, base:9.50, expense:3.10, unlockCost:1200, risk:28, rep:6 },
      { id:"studio",name:"Game Studio",   unlocked:false, level:0, base:28.0, expense:11.0,unlockCost:6000, risk:35, rep:10 },
    ],
    upgrades:{ analytics:0, security:0, pr:0, automation:0 }
  };

  function load(){
    try{
      const raw=localStorage.getItem(KEY);
      if(!raw) return;
      const data=JSON.parse(raw);
      Object.assign(S,data);
      S.upgrades ||= {analytics:0,security:0,pr:0,automation:0};
      S.loans ||= [];
      S.assets ||= [];
      S.businesses ||= [];
    }catch(e){}
  }
  function save(showToast=true){
    S.lastSave=now();
    localStorage.setItem(KEY, JSON.stringify(S));
    if(showToast) toast("Saved.");
  }
  load();

  // ----- Offline progress (works when tab is minimized) -----
  function applyOffline(showToastMsg=true){
    const t=now();
    const dt=Math.max(0,(t-(S.lastTick||t))/1000);
    if(dt < 2) { S.lastTick=t; return; }
    const capped=Math.min(dt, 8*3600); // cap at 8h
    const { netPerSec } = computeRates();
    const gain = netPerSec * capped;
    S.money += gain;
    if(gain>=0) S.totalEarned += gain; else S.totalLost += -gain;
    S.lastTick=t;
    if(showToastMsg) toast(`Offline earnings: ${moneyFmt(gain)} (${Math.round(capped/60)} min)`);
  }
  applyOffline(false);

  // When hidden, save timestamp; when visible, award offline progress.
  document.addEventListener("visibilitychange", () => {
    if(document.visibilityState === "hidden"){
      S.lastTick = now();
      save(false);
    } else {
      applyOffline(true);
      renderAll();
    }
  });

  // ----- Toast -----
  const toastEl=document.getElementById("toast");
  let toastT=0;
  function toast(msg){
    toastEl.textContent=msg;
    toastEl.style.display="block";
    toastT=3.5;
  }

  // ----- Game math -----
  const clamp01 = (x)=>Math.max(0,Math.min(1,x));

  function assetUpkeepPerSec(){
    return S.assets.reduce((sum,a)=>sum+(a.upkeepPerSec||0),0);
  }
  function lifestyleEffects(){
    let rep=0, risk=0, qol=0;
    for(const a of S.assets){
      rep += (a.rep||0);
      risk += (a.risk||0);
      qol += (a.qol||0);
    }
    return { rep, risk, qol };
  }
  function updateAssetValues(dt){
    const year = 365*24*3600;
    for(const a of S.assets){
      if(!a.annualRate || a.value<=0) continue;
      a.value = Math.max(0, a.value * (1 + (a.annualRate/year)*dt));
    }
  }

  function computeRates(){
    const policyIncomeMult = S.policy==="conservative" ? 0.90 : S.policy==="aggressive" ? 1.12 : 1.00;
    const policyRiskDelta  = S.policy==="conservative" ? -6 : S.policy==="aggressive" ? +10 : 0;

    const analyticsMult = 1 + 0.08*S.upgrades.analytics;
    const automationExpenseMult = 1 - 0.05*S.upgrades.automation;

    const life = lifestyleEffects();

    // QoL and reputation are small, steady multipliers
    const qolIncomeMult = 0.92 + (S.qol/100)*0.16;           // 0.92..1.08
    const repIncomeMult = 0.85 + (S.reputation/100)*0.35;    // 0.85..1.20

    let income=0, expenses=0, baseRisk=0;
    for(const b of S.businesses){
      if(!b.unlocked || b.level<=0) continue;
      income += b.base * b.level;
      expenses += b.expense * b.level;
      baseRisk += b.risk * Math.sqrt(b.level);
    }

    // loans
    let loanPay=0;
    for(const L of S.loans) loanPay += L.paymentPerSec;

    // lifestyle upkeep
    const lifeUpkeep = assetUpkeepPerSec();

    income *= policyIncomeMult * analyticsMult * repIncomeMult * qolIncomeMult;
    expenses *= automationExpenseMult;

    // risk
    let risk = baseRisk/10 + 20;
    risk += policyRiskDelta;
    risk -= 7*S.upgrades.security;
    risk += life.risk;
    risk -= (S.reputation-50)*0.08;
    risk = clamp(risk, 0, 100);

    // reputation drift: PR + high QoL helps; high risk hurts
    const repDrift = (0.02*S.upgrades.pr) + (S.qol>70 ? 0.01 : 0) - (risk>65 ? 0.015 : 0);

    const netPerSec = income - (expenses + loanPay + lifeUpkeep);
    return { incomePerSec:income, expensePerSec:(expenses+loanPay+lifeUpkeep), netPerSec, risk, repDrift };
  }

  function updateDerived(){
    const rates = computeRates();
    S.risk = rates.risk;

    const businessValue = S.businesses.reduce((sum,b)=>{
      if(!b.unlocked||b.level<=0) return sum;
      const approxNet = Math.max(0, (b.base - b.expense) * b.level);
      return sum + approxNet * 60 * 25;
    },0);

    const assetsValue = S.assets.reduce((s,a)=>s+(a.value||0),0);
    const loanRemaining = S.loans.reduce((s,L)=>s+(L.remaining||0),0);

    const netWorth = S.money + businessValue + assetsValue - loanRemaining;
    return { ...rates, businessValue, assetsValue, loanRemaining, netWorth };
  }

  // ----- Loans -----
  let loanId=1;
  function takeLoan(amount, apr){
    const paymentPerSec = (amount*(apr/100))/(365*24*3600) + (amount/(10*60));
    S.loans.push({ id:"L"+(loanId++), principal:amount, rateAPR:apr, paymentPerSec, remaining:amount });
    S.money += amount; S.totalEarned += amount;
    toast(`Loan received: +${moneyFmt(amount)} (APR ${apr}%).`);
  }
  function tickLoans(dt){
    for(let i=S.loans.length-1;i>=0;i--){
      const L=S.loans[i];
      const pay = L.paymentPerSec*dt;
      S.money -= pay; S.totalLost += pay;
      L.remaining = Math.max(0, L.remaining - (pay*0.92));
      if(L.remaining <= 0.01){
        toast(`Loan repaid (${L.id}).`);
        S.loans.splice(i,1);
      }
    }
  }

  // ----- Business costs -----
  function upgradeCost(b){
    return Math.floor(60 + (b.level*b.level) * (b.unlockCost? (b.unlockCost/18) : 28));
  }
  function upgradeTile(key, name, desc, cost){
    const level=S.upgrades[key]||0;
    const can=S.money>=cost;
    return `
      <div class="item">
        <h3>${name} <span class="badge">Level ${level}</span></h3>
        <div class="muted">${desc}</div>
        <div style="height:10px"></div>
        <button class="btn ${can?"":"ghost"}" ${can?"":"disabled"} data-u="${key}" data-cost="${cost}">
          Buy (${moneyFmt(cost)})
        </button>
      </div>
    `;
  }

  // ----- UI refs -----
  const moneyEl=document.getElementById("money");
  const netEl=document.getElementById("net");
  const rateEl=document.getElementById("rate");
  const qolEl=document.getElementById("qol");
  document.getElementById("saveBtn").onclick=()=>save(true);

  const tabOverview=document.getElementById("tab-overview");
  const tabBusiness=document.getElementById("tab-business");
  const tabLifestyle=document.getElementById("tab-lifestyle");
  const tabFinance=document.getElementById("tab-finance");
  const tabReports=document.getElementById("tab-reports");

  // ----- Tabs -----
  function setTab(name){
    for(const pane of document.querySelectorAll(".tabpane")) pane.style.display="none";
    for(const btn of document.querySelectorAll(".tab")) btn.classList.remove("active");
    document.querySelector(`.tab[data-tab="${name}"]`).classList.add("active");
    document.getElementById("tab-"+name).style.display="block";
    renderAll();
  }
  document.querySelectorAll(".tab").forEach(b=>b.onclick=()=>setTab(b.dataset.tab));

  // ----- Renderers -----
  function renderOverview(){
    const d=updateDerived();
    const repBar=Math.round(S.reputation);
    const riskBar=Math.round(S.risk);
    const qolBar=Math.round(S.qol);

    tabOverview.innerHTML=`
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Overview</div>
            <div class="muted">You earn continuously. When the tab is minimized, you earn via offline progress when you return.</div>
          </div>
          <button class="btn ghost" id="resetBtn">Reset</button>
        </div>

        <div style="height:10px"></div>
        <div class="grid3">
          <div class="item">
            <h3>Reputation</h3>
            <div class="bar"><div style="width:${repBar}%"></div></div>
            <div class="muted" style="margin-top:6px">${repBar}/100</div>
          </div>
          <div class="item">
            <h3>Risk</h3>
            <div class="bar"><div style="width:${riskBar}%;background:linear-gradient(90deg,var(--danger), #ffb86b)"></div></div>
            <div class="muted" style="margin-top:6px">${riskBar}/100</div>
          </div>
          <div class="item">
            <h3>Quality of Life</h3>
            <div class="bar"><div style="width:${qolBar}%;background:linear-gradient(90deg,var(--accent2), var(--good))"></div></div>
            <div class="muted" style="margin-top:6px">${qolBar}/100</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="item">
          <div class="row">
            <div>
              <h3>Policy</h3>
              <div class="muted">Conservative = safer. Aggressive = faster growth but more incidents.</div>
            </div>
            <div class="grid3" style="min-width:260px">
              <button class="btn ${S.policy==="conservative"?"good":"ghost"}" id="polC">Conservative</button>
              <button class="btn ${S.policy==="balanced"?"good":"ghost"}" id="polB">Balanced</button>
              <button class="btn ${S.policy==="aggressive"?"good":"ghost"}" id="polA">Aggressive</button>
            </div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("polC").onclick=()=>{S.policy="conservative"; save(false); renderAll();};
    document.getElementById("polB").onclick=()=>{S.policy="balanced"; save(false); renderAll();};
    document.getElementById("polA").onclick=()=>{S.policy="aggressive"; save(false); renderAll();};

    document.getElementById("resetBtn").onclick=()=>{
      if(!confirm("Reset game? This resets everything.")) return;
      localStorage.removeItem(KEY);
      location.reload();
    };
  }

  function renderBusinesses(){
    const list = S.businesses.map(b=>{
      const locked=!b.unlocked;
      const lvl=b.level||0;
      const canUnlock=locked && S.money>=b.unlockCost;
      const canUpgrade=b.unlocked && S.money>=upgradeCost(b);
      const net = b.unlocked ? (b.base-b.expense)*lvl : 0;
      return `
        <div class="item">
          <div class="row">
            <div>
              <h3>${b.name} ${b.unlocked?`<span class="badge">Level ${lvl}</span>`:`<span class="badge">Locked</span>`}</h3>
              <div class="muted">${b.unlocked
                ? `Base: ${moneyFmt(b.base)}/s • Expense: ${moneyFmt(b.expense)}/s • Approx net: ${moneyFmt(net)}/s`
                : `Unlock cost: ${moneyFmt(b.unlockCost)}`
              }</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              ${locked
                ? `<button class="btn ${canUnlock?"":"ghost"}" ${canUnlock?"":"disabled"} data-unlock="${b.id}">Unlock</button>`
                : `<button class="btn ${canUpgrade?"":"ghost"}" ${canUpgrade?"":"disabled"} data-up="${b.id}">Upgrade (${moneyFmt(upgradeCost(b))})</button>`
              }
            </div>
          </div>
        </div>
      `;
    }).join("");

    tabBusiness.innerHTML=`
      <div class="card">
        <div class="big">Businesses</div>
        <div class="muted">Unlock and upgrade income streams.</div>
        <div style="height:10px"></div>
        <div class="list">${list}</div>
      </div>

      <div class="card">
        <div class="big">Upgrades (global)</div>
        <div class="muted">These affect all businesses.</div>
        <div style="height:10px"></div>
        <div class="grid2">
          ${upgradeTile("analytics","Analytics","Boosts income; slightly lowers risk over time",140*(S.upgrades.analytics+1))}
          ${upgradeTile("security","Security","Reduces risk and incident losses",170*(S.upgrades.security+1))}
          ${upgradeTile("pr","PR & Trust","Slowly increases reputation",150*(S.upgrades.pr+1))}
          ${upgradeTile("automation","Automation","Reduces operating expenses",190*(S.upgrades.automation+1))}
        </div>
      </div>
    `;

    tabBusiness.querySelectorAll("[data-unlock]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-unlock");
        const b=S.businesses.find(x=>x.id===id);
        if(!b || b.unlocked || S.money<b.unlockCost) return;
        S.money-=b.unlockCost; S.totalLost+=b.unlockCost;
        b.unlocked=true; b.level=1;
        S.reputation=clamp(S.reputation+2,0,100);
        toast(`Unlocked: ${b.name}`);
        save(false); renderAll();
      };
    });

    tabBusiness.querySelectorAll("[data-up]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-up");
        const b=S.businesses.find(x=>x.id===id);
        const cost=upgradeCost(b);
        if(!b || !b.unlocked || S.money<cost) return;
        S.money-=cost; S.totalLost+=cost;
        b.level += 1;
        S.risk = clamp(S.risk + 1.0, 0, 100);
        S.reputation = clamp(S.reputation + 0.6, 0, 100);
        toast(`${b.name} upgraded to Level ${b.level}`);
        save(false); renderAll();
      };
    });

    tabBusiness.querySelectorAll("[data-u]").forEach(btn=>{
      btn.onclick=()=>{
        const key=btn.getAttribute("data-u");
        const cost=Number(btn.getAttribute("data-cost"));
        if(S.money < cost) return toast("Not enough cash.");
        S.money-=cost; S.totalLost+=cost;
        S.upgrades[key]+=1;
        if(key==="security") S.risk=clamp(S.risk-6,0,100);
        if(key==="pr") S.reputation=clamp(S.reputation+3,0,100);
        toast(`Upgrade purchased: ${key}`);
        save(false); renderAll();
      };
    });
  }

  function renderLifestyle(){
    const owned = new Map(S.assets.map(a=>[a.id,a]));
    const assetsValue = S.assets.reduce((s,a)=>s+(a.value||0),0);
    const upkeep = assetUpkeepPerSec();

    // Owned section
    const ownedHtml = S.assets.length===0
      ? `<div class="muted">No personal assets yet. Buy items below.</div>`
      : S.assets.map(a=>{
          const resale = a.value>0 ? Math.floor(a.value * 0.70) : 0;
          const canSell = resale>0 && !a.consumable;
          const canCancel = !!a.cancelable && (a.upkeepPerSec||0) > 0;
          return `
            <div class="item">
              <div class="row">
                <div>
                  <h3>${a.name} <span class="badge">${a.type}</span></h3>
                  <div class="muted">
                    ${a.value>0?`Current value: <b>${moneyFmt(a.value)}</b> • `:""}
                    ${a.upkeepPerSec>0?`Upkeep: <b>${moneyFmt(a.upkeepPerSec)}/s</b>`:"No upkeep"}
                  </div>
                  <div class="muted">Effects: QoL ${a.qol>=0?`+${a.qol}`:a.qol} • Rep ${a.rep>=0?`+${a.rep}`:a.rep} • Risk ${a.risk>=0?`+${a.risk}`:a.risk}</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
                  ${canSell?`<button class="btn ghost" data-sell="${a.id}">Sell (${moneyFmt(resale)})</button>`:""}
                  ${canCancel?`<button class="btn ghost" data-cancel="${a.id}">Cancel</button>`:""}
                </div>
              </div>
            </div>
          `;
        }).join("");

    // Shop section grouped by type
    const groups = {};
    for(const it of LIFESTYLE) (groups[it.type] ||= []).push(it);

    const sections = Object.keys(groups).map(type=>{
      const rows = groups[type].map(it=>{
        const isOwned = owned.has(it.id) && !it.consumable; // consumables can be bought multiple times
        const canBuy = (!isOwned) && (S.money >= it.cost);
        const upkeepTxt = it.upkeepPerSec>0 ? ` • Upkeep: <b>${moneyFmt(it.upkeepPerSec)}/s</b>` : ``;
        const valueTxt = it.value>0 ? ` • Value: <b>${moneyFmt(it.value)}</b>` : ``;
        const tag = it.consumable ? `<span class="badge">Consumable</span>` : (isOwned ? `<span class="badge">Owned</span>` : ``);

        return `
          <div class="item">
            <div class="row">
              <div>
                <h3>${it.name} ${tag}</h3>
                <div class="muted">Cost: <b>${moneyFmt(it.cost)}</b>${upkeepTxt}${valueTxt}</div>
                <div class="muted">Effects: QoL ${it.qol>=0?`+${it.qol}`:it.qol} • Rep ${it.rep>=0?`+${it.rep}`:it.rep} • Risk ${it.risk>=0?`+${it.risk}`:it.risk}</div>
              </div>
              <div>
                <button class="btn ${canBuy?"":"ghost"}" ${canBuy?"":"disabled"} data-buy="${it.id}">Buy</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      return `<div class="card"><div class="big">${type}</div><div class="list">${rows}</div></div>`;
    }).join("");

    tabLifestyle.innerHTML=`
      <div class="card">
        <div class="row">
          <div>
            <div class="big">Lifestyle</div>
            <div class="muted">Buy personal items: some increase net worth (assets), some improve QoL, and some add upkeep.</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Assets value</div>
            <div style="font-weight:900">${moneyFmt(assetsValue)}</div>
            <div class="muted">Upkeep</div>
            <div style="font-weight:900">${moneyFmt(upkeep)}/s</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="big">Owned</div>
        <div class="list">${ownedHtml}</div>
      </div>

      ${sections}

      <div class="card">
        <div class="big">Tip</div>
        <div class="muted">
          Subscriptions can drain you if you buy too many early. Homes appreciate slowly, cars depreciate.
          If you want “background earning”, keep your net income positive and rely on offline earnings when you return.
        </div>
      </div>
    `;

    // Buy
    tabLifestyle.querySelectorAll("[data-buy]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-buy");
        const it=LIFESTYLE.find(x=>x.id===id);
        if(!it) return;
        if(!it.consumable && S.assets.some(a=>a.id===id)) return toast("Already owned.");
        if(S.money < it.cost) return toast("Not enough cash.");

        S.money -= it.cost; S.totalLost += it.cost;

        // consumables apply effects but are not stored
        if(it.consumable){
          S.qol = clamp(S.qol + (it.qol||0), 0, 100);
          S.reputation = clamp(S.reputation + (it.rep||0), 0, 100);
          S.risk = clamp(S.risk + (it.risk||0), 0, 100);
          toast(`Enjoyed: ${it.name}`);
          save(false); renderAll();
          return;
        }

        S.assets.push({
          id: it.id, name: it.name, type: it.type,
          purchaseTime: now(),
          value: it.value||0,
          upkeepPerSec: it.upkeepPerSec||0,
          annualRate: it.annualRate||0,
          qol: it.qol||0,
          rep: it.rep||0,
          risk: it.risk||0,
          cancelable: !!it.cancelable,
          consumable: !!it.consumable
        });

        S.qol = clamp(S.qol + (it.qol||0), 0, 100);
        S.reputation = clamp(S.reputation + (it.rep||0), 0, 100);
        S.risk = clamp(S.risk + (it.risk||0), 0, 100);

        toast(`Purchased: ${it.name}`);
        save(false); renderAll();
      };
    });

    // Sell (70% of current value)
    tabLifestyle.querySelectorAll("[data-sell]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-sell");
        const idx=S.assets.findIndex(a=>a.id===id);
        if(idx<0) return;
        const a=S.assets[idx];
        const payout = Math.floor((a.value||0) * 0.70);
        if(payout <= 0) return;
        S.money += payout; S.totalEarned += payout;
        // remove asset and reverse effects
        S.qol = clamp(S.qol - (a.qol||0), 0, 100);
        S.reputation = clamp(S.reputation - (a.rep||0), 0, 100);
        S.risk = clamp(S.risk - (a.risk||0), 0, 100);
        S.assets.splice(idx,1);
        toast(`Sold: ${a.name} (+${moneyFmt(payout)})`);
        save(false); renderAll();
      };
    });

    // Cancel (stop upkeep; keep history by removing item)
    tabLifestyle.querySelectorAll("[data-cancel]").forEach(btn=>{
      btn.onclick=()=>{
        const id=btn.getAttribute("data-cancel");
        const idx=S.assets.findIndex(a=>a.id===id);
        if(idx<0) return;
        const a=S.assets[idx];
        // remove and reverse effects (subscriptions shouldn’t permanently buff you)
        S.qol = clamp(S.qol - (a.qol||0), 0, 100);
        S.reputation = clamp(S.reputation - (a.rep||0), 0, 100);
        S.risk = clamp(S.risk - (a.risk||0), 0, 100);
        S.assets.splice(idx,1);
        toast(`Canceled: ${a.name}`);
        save(false); renderAll();
      };
    });
  }

  function renderFinance(){
    const loanHtml = S.loans.length===0 ? `<div class="muted">No active loans.</div>` : S.loans.map(L=>`
      <div class="item">
        <h3>Loan ${L.id}</h3>
        <div class="muted">APR ${L.rateAPR}% • Remaining ${moneyFmt(L.remaining)} • Payment ${moneyFmt(L.paymentPerSec)}/s</div>
      </div>`).join("");

    tabFinance.innerHTML=`
      <div class="card">
        <div class="big">Finance</div>
        <div class="muted">Loans accelerate growth, but debt reduces net income.</div>
        <div style="height:10px"></div>
        <div class="grid2">
          <div class="item">
            <h3>Small loan</h3>
            <div class="muted">Useful early, moderate APR.</div>
            <div style="height:8px"></div>
            <button class="btn" id="loan1">Borrow ${moneyFmt(300)} (APR 18%)</button>
          </div>
          <div class="item">
            <h3>Growth loan</h3>
            <div class="muted">More cash, more pressure.</div>
            <div style="height:8px"></div>
            <button class="btn danger" id="loan2">Borrow ${moneyFmt(1200)} (APR 28%)</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="item">
          <h3>Active loans</h3>
          ${loanHtml}
        </div>
      </div>
    `;

    document.getElementById("loan1").onclick=()=>{
      if(S.loans.length>=3) return toast("Too many active loans.");
      takeLoan(300,18); save(false); renderAll();
    };
    document.getElementById("loan2").onclick=()=>{
      if(S.loans.length>=3) return toast("Too many active loans.");
      S.risk = clamp(S.risk + 6, 0, 100);
      takeLoan(1200,28); save(false); renderAll();
    };
  }

  function renderReports(){
    const d=updateDerived();
    tabReports.innerHTML=`
      <div class="card">
        <div class="big">Reports</div>
        <div class="muted">Wealth breakdown and net income drivers.</div>
        <div style="height:10px"></div>
        <div class="grid2">
          <div class="item">
            <h3>Totals</h3>
            <div class="muted">Earned: <b>${moneyFmt(S.totalEarned)}</b></div>
            <div class="muted">Lost: <b>${moneyFmt(S.totalLost)}</b></div>
          </div>
          <div class="item">
            <h3>Net worth</h3>
            <div class="muted">Business value: <b>${moneyFmt(d.businessValue)}</b></div>
            <div class="muted">Assets value: <b>${moneyFmt(d.assetsValue)}</b></div>
            <div class="muted">Loan remaining: <b>${moneyFmt(d.loanRemaining)}</b></div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="item">
          <h3>Rates</h3>
          <div class="muted">Income: <b>${moneyFmt(d.incomePerSec)}/s</b></div>
          <div class="muted">Expenses+Debt+Upkeep: <b>${moneyFmt(d.expensePerSec)}/s</b></div>
          <div class="muted">Net: <b>${moneyFmt(d.netPerSec)}/s</b></div>
        </div>
      </div>
    `;
  }

  function renderAll(){
    const d=updateDerived();
    moneyEl.textContent = moneyFmt(S.money);
    netEl.textContent = moneyFmt(d.netWorth);
    rateEl.textContent = `${moneyFmt(d.netPerSec)}/s`;
    qolEl.textContent = String(Math.round(S.qol));

    renderOverview();
    renderBusinesses();
    renderLifestyle();
    renderFinance();
    renderReports();
  }

  // ----- Main Loop -----
  let last=performance.now();
  function loop(t){
    const dt=Math.min(0.05,(t-last)/1000);
    last=t;

    drawBG(dt);
    updateAssetValues(dt);

    const r = computeRates();
    const delta = r.netPerSec * dt;
    S.money += delta;
    if(delta>=0) S.totalEarned += delta; else S.totalLost += -delta;

    // rep drift
    S.reputation = clamp(S.reputation + r.repDrift*dt*60, 0, 100);

    // QoL drift: too much upkeep with low cash causes stress
    const upkeep = assetUpkeepPerSec();
    if(upkeep > r.incomePerSec*0.45 && S.money < 100){
      S.qol = clamp(S.qol - 0.8*dt, 0, 100);
    } else {
      S.qol = clamp(S.qol + 0.08*dt, 0, 100);
    }

    tickLoans(dt);

    // autosave
    if((now()-(S.lastSave||0))>15000) save(false);

    // toast fade
    if(toastT>0){ toastT-=dt; if(toastT<=0) toastEl.style.display="none"; }

    // stamp for offline progress
    S.lastTick = now();

    // update header KPIs lightly
    const dd = updateDerived();
    moneyEl.textContent = moneyFmt(S.money);
    netEl.textContent = moneyFmt(dd.netWorth);
    rateEl.textContent = `${moneyFmt(dd.netPerSec)}/s`;
    qolEl.textContent = String(Math.round(S.qol));

    requestAnimationFrame(loop);
  }

  // start
  renderAll();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
